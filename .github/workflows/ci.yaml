name: E-Commerce container build

on:
  push:
    branches:
      - development

jobs:
  build:
    runs-on: self-hosted  # The job runs on a self-hosted runner to avoid cost for the case study

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Read version from manifest.json
        id: get_version
        run: |
          VERSION=$(jq -r '.version' manifest.json)
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image (builder stage)
        run: docker buildx build --load --target builder -t wp-release:builder .

      - name: Security Scan with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: wp-release:builder
      
      - name: Run PHP Unit Tests
        run: |
          docker run --rm -e HTTP_HOST=localhost -e WORDPRESS_DB_HOST=localhost -e WORDPRESS_DB_USER=root -e WORDPRESS_DB_PASSWORD=root wp-release:builder phpunit --configuration phpunit.xml

